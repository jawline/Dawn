<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Dawn OS: Kernel/sources/heap/heap.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>Kernel/sources/heap/heap.c</h1>  </div>
</div>
<div class="contents">
<a href="_kernel_2sources_2heap_2heap_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &lt;<a class="code" href="heap_8h.html">heap/heap.h</a>&gt;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &lt;<a class="code" href="_kernel_2headers_2printf_8h.html">printf.h</a>&gt;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html">debug/debug.h</a>&gt;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;<a class="code" href="panic_8h.html">panic/panic.h</a>&gt;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;<a class="code" href="virt__mm_8h.html">mm/virt_mm.h</a>&gt;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;<a class="code" href="phys__mm_8h.html">mm/phys_mm.h</a>&gt;</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> <a class="code" href="_kernel_2sources_2heap_2heap_8c.html#ab80d68399dbb045d1b1b821c560ec7df">alloc_mem</a>(<a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> <a class="code" href="multiboot_8h.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a>, <a class="code" href="structheap__t.html">heap_t</a> * heap);
<a name="l00009"></a>00009 <span class="keywordtype">void</span> <a class="code" href="_kernel_2sources_2heap_2heap_8c.html#adcb6f95229d37c5dbfd89ce01280b178">free_mem</a>(<a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> address, <a class="code" href="structheap__t.html">heap_t</a> * heap);
<a name="l00010"></a>00010 
<a name="l00015"></a><a class="code" href="_kernel_2sources_2heap_2heap_8c.html#ade657aeee4e0f8c2b0b4593bcff4af81">00015</a> <span class="keywordtype">void</span> <a class="code" href="_kernel_2sources_2heap_2heap_8c.html#ade657aeee4e0f8c2b0b4593bcff4af81" title="Initializes a new heap at address specified and maps memory from free frames for it.">initializeHeap</a>(<a class="code" href="structheap__t.html">heap_t</a> * heap, <a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> address)
<a name="l00016"></a>00016 {
<a name="l00017"></a>00017         <span class="comment">//Double check the heap ptr is valid</span>
<a name="l00018"></a>00018         <span class="keywordflow">if</span> (heap == 0) <span class="keywordflow">return</span>;
<a name="l00019"></a>00019 
<a name="l00020"></a>00020         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Debug Message: Creating Heap\n&quot;</span>);
<a name="l00021"></a>00021         <a class="code" href="common_8h.html#ab0985f366b55a4fd2d24cefe66340bc0">memset</a>(heap, 0, <span class="keyword">sizeof</span>(<a class="code" href="structheap__t.html">heap_t</a>));
<a name="l00022"></a>00022         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Debug Message: 0&#39;ed Heap\n&quot;</span>);
<a name="l00023"></a>00023 
<a name="l00024"></a>00024         <span class="comment">//Set the heap location to the specified address</span>
<a name="l00025"></a>00025         heap-&gt;<a class="code" href="structheap__t.html#a215fe2a240fb3019c5e486781d8e967f">heap_location</a> = address &amp; PAGE_MASK; <span class="comment">//Page aligned boundry</span>
<a name="l00026"></a>00026         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Debug Message: Heap Location &quot;</span>);
<a name="l00027"></a>00027         <a class="code" href="debugprint_8h.html#ac60b666ea684eb88d4ccd46b08759ca7">DEBUG_PRINTX</a>(heap-&gt;<a class="code" href="structheap__t.html#a215fe2a240fb3019c5e486781d8e967f">heap_location</a>);
<a name="l00028"></a>00028         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00029"></a>00029 
<a name="l00030"></a>00030         <a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> frame_addr = 0;
<a name="l00031"></a>00031 
<a name="l00032"></a>00032         frame_addr = 0;
<a name="l00033"></a>00033 
<a name="l00034"></a>00034         frame_addr = <a class="code" href="phys__mm_8h.html#ae86135800d71ebffbb2785b058373cd4">allocateFrame</a>();
<a name="l00035"></a>00035 
<a name="l00036"></a>00036         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Debug Message: Allocated frame &quot;</span>);
<a name="l00037"></a>00037         <a class="code" href="debugprint_8h.html#ac60b666ea684eb88d4ccd46b08759ca7">DEBUG_PRINTX</a>(frame_addr);
<a name="l00038"></a>00038         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00039"></a>00039 
<a name="l00040"></a>00040         <a class="code" href="virt__mm_8h.html#a8aa47a82f681426ba335dd779424f705">map</a>(heap-&gt;<a class="code" href="structheap__t.html#a215fe2a240fb3019c5e486781d8e967f">heap_location</a>, frame_addr, <a class="code" href="virt__mm_8h.html#a122dfc414a40e260fd35dbe9743db26f">PAGE_PRESENT</a> | <a class="code" href="virt__mm_8h.html#a2d0253527ea5080d6befe0ee3bde473f">PAGE_USER</a>);
<a name="l00041"></a>00041 
<a name="l00042"></a>00042         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Debug Message: Mapped Heap\n&quot;</span>);
<a name="l00043"></a>00043 
<a name="l00044"></a>00044         <a class="code" href="common_8h.html#ab0985f366b55a4fd2d24cefe66340bc0">memset</a>(heap-&gt;<a class="code" href="structheap__t.html#a215fe2a240fb3019c5e486781d8e967f">heap_location</a>, 0, 4096);
<a name="l00045"></a>00045         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Debug Message: 0&#39;ed HEAP\n&quot;</span>);
<a name="l00046"></a>00046 
<a name="l00047"></a>00047         <a class="code" href="structheap__entry.html">heap_entry_t</a> * ptr = (<a class="code" href="structheap__entry.html">heap_entry_t</a> *) heap-&gt;<a class="code" href="structheap__t.html#a215fe2a240fb3019c5e486781d8e967f">heap_location</a>;
<a name="l00048"></a>00048         <a class="code" href="common_8h.html#ab0985f366b55a4fd2d24cefe66340bc0">memset</a>(ptr, 0, <span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>)); <span class="comment">//Initialize it.</span>
<a name="l00049"></a>00049         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Debug Message: Created first heap entry\n&quot;</span>);
<a name="l00050"></a>00050 
<a name="l00051"></a>00051         ptr-&gt;<a class="code" href="structheap__entry.html#a4c6c3bc56b1a413e4cf5020927df2b57">used</a> = 0; <span class="comment">//Not used</span>
<a name="l00052"></a>00052         ptr-&gt;<a class="code" href="structheap__entry.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a> = <a class="code" href="virt__mm_8h.html#a6223bf065444cd678be8eb78bebaa5ba">PAGE_SIZE</a> - <span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>); <span class="comment">//One frame has been allocated. 4096 bytes of heap space at the minute. The heap entrys are also in the space so we need to take into account for them (Only one at the minute though =) )</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Debug Message: Set ptr size\n&quot;</span>);
<a name="l00055"></a>00055 
<a name="l00056"></a>00056         ptr-&gt;<a class="code" href="structheap__entry.html#a90018fa1ca3eed17d857c9a9785a177b">next</a> = 0; <span class="comment">//ptr-&gt;next = NULL, this tells the heap that this is the last entry on the heap.</span>
<a name="l00057"></a>00057         ptr-&gt;<a class="code" href="structheap__entry.html#a8bc8f936f7d3b69b921f7339ff6f1cc9">prev</a> = 0;
<a name="l00058"></a>00058         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Debug Message: Ptr-&gt;next set\n&quot;</span>);
<a name="l00059"></a>00059 }
<a name="l00060"></a>00060 
<a name="l00065"></a><a class="code" href="_kernel_2sources_2heap_2heap_8c.html#a24a780b4e38547b00f955a39a83a466f">00065</a> <a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> <a class="code" href="_kernel_2sources_2heap_2heap_8c.html#a24a780b4e38547b00f955a39a83a466f" title="Allocates x bytes of memory from a heap, expanding it if necessary.">heapAllocateMemory</a>(<a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> <a class="code" href="multiboot_8h.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a>, <a class="code" href="structheap__t.html">heap_t</a>* heap) 
<a name="l00066"></a>00066 {
<a name="l00067"></a>00067         <a class="code" href="structheap__entry.html">heap_entry_t</a>* ptr = (<a class="code" href="structheap__entry.html">heap_entry_t</a>*) heap-&gt;<a class="code" href="structheap__t.html#a215fe2a240fb3019c5e486781d8e967f">heap_location</a>;
<a name="l00068"></a>00068         <a class="code" href="int__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> result = 0;
<a name="l00069"></a>00069 
<a name="l00070"></a>00070         while (1) 
<a name="l00071"></a>00071         {
<a name="l00072"></a>00072 
<a name="l00073"></a>00073                 <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structheap__entry.html#a4c6c3bc56b1a413e4cf5020927df2b57">used</a> == 0) <span class="comment">//Is the chunk in use?</span>
<a name="l00074"></a>00074                 { 
<a name="l00075"></a>00075                         <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structheap__entry.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a> &gt; size) <span class="comment">//Is it big enough!?!</span>
<a name="l00076"></a>00076                         { 
<a name="l00077"></a>00077                                 ptr-&gt;<a class="code" href="structheap__entry.html#a4c6c3bc56b1a413e4cf5020927df2b57">used</a> = 1; <span class="comment">//Yay it fits!</span>
<a name="l00078"></a>00078                                 
<a name="l00079"></a>00079                                 <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structheap__entry.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a> &lt; size + (<span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>))) 
<a name="l00080"></a>00080                                 { <span class="comment">//If another chunk of memory wont fit then just allocate a few more bytes then asked for (Avoid leak)</span>
<a name="l00081"></a>00081                                         <span class="comment">//Don&#39;t actually need to do anything. The next ptr is still the next pointer</span>
<a name="l00082"></a>00082                                 } 
<a name="l00083"></a>00083                                 <span class="keywordflow">else</span> 
<a name="l00084"></a>00084                                 {
<a name="l00085"></a>00085                                         <a class="code" href="structheap__entry.html">heap_entry_t</a>* newptr = (<a class="code" href="structheap__entry.html">heap_entry_t</a>*) (((<a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a>) ptr) + <span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>) + size);
<a name="l00086"></a>00086                                         newptr-&gt;<a class="code" href="structheap__entry.html#a4c6c3bc56b1a413e4cf5020927df2b57">used</a> = 0;
<a name="l00087"></a>00087                                         newptr-&gt;<a class="code" href="structheap__entry.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a> = ptr-&gt;<a class="code" href="structheap__entry.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a> - size - <span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>);
<a name="l00088"></a>00088                                         newptr-&gt;<a class="code" href="structheap__entry.html#a90018fa1ca3eed17d857c9a9785a177b">next</a> = ptr-&gt;<a class="code" href="structheap__entry.html#a90018fa1ca3eed17d857c9a9785a177b">next</a>;
<a name="l00089"></a>00089                                         newptr-&gt;<a class="code" href="structheap__entry.html#a8bc8f936f7d3b69b921f7339ff6f1cc9">prev</a> = ptr;
<a name="l00090"></a>00090                                         ptr-&gt;<a class="code" href="structheap__entry.html#a90018fa1ca3eed17d857c9a9785a177b">next</a> = newptr;
<a name="l00091"></a>00091                                         ptr-&gt;<a class="code" href="structheap__entry.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a> = size;
<a name="l00092"></a>00092                                 }
<a name="l00093"></a>00093 
<a name="l00094"></a>00094                                 <span class="keywordflow">return</span> ((<a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a>) ptr) + <span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>); <span class="comment">//Return the location of the actual memory not the header</span>
<a name="l00095"></a>00095                         }
<a name="l00096"></a>00096                 }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098                 <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structheap__entry.html#a90018fa1ca3eed17d857c9a9785a177b">next</a> == 0) 
<a name="l00099"></a>00099                 {
<a name="l00100"></a>00100                         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Heap expanded by 4KB\n&quot;</span>);
<a name="l00101"></a>00101                         <span class="comment">//Map another 4kb onto the heap</span>
<a name="l00102"></a>00102                         <span class="comment">//This is the last entry on the heap SO if its not used we can just += the size otherwise we have to create a whole new one (More work for mee)</span>
<a name="l00103"></a>00103 
<a name="l00104"></a>00104                         <a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> frame_addr = <a class="code" href="phys__mm_8h.html#ae86135800d71ebffbb2785b058373cd4">allocateFrame</a>();
<a name="l00105"></a>00105                         <a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> end = ((uint32) ptr) + ptr-&gt;<a class="code" href="structheap__entry.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>);
<a name="l00106"></a>00106 
<a name="l00107"></a>00107                         <a class="code" href="virt__mm_8h.html#a8aa47a82f681426ba335dd779424f705">map</a>(end, frame_addr, <a class="code" href="virt__mm_8h.html#a122dfc414a40e260fd35dbe9743db26f">PAGE_PRESENT</a> | <a class="code" href="virt__mm_8h.html#a2d0253527ea5080d6befe0ee3bde473f">PAGE_USER</a>); <span class="comment">//Mapped now! =)</span>
<a name="l00108"></a>00108 
<a name="l00109"></a>00109                         <a class="code" href="common_8h.html#ab0985f366b55a4fd2d24cefe66340bc0">memset</a>(end, 0, 4096);
<a name="l00110"></a>00110                         
<a name="l00111"></a>00111                         <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structheap__entry.html#a4c6c3bc56b1a413e4cf5020927df2b57">used</a> == 0) 
<a name="l00112"></a>00112                         {
<a name="l00113"></a>00113                                 ptr-&gt;<a class="code" href="structheap__entry.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a> += 4096;
<a name="l00114"></a>00114                         } 
<a name="l00115"></a>00115                         <span class="keywordflow">else</span> 
<a name="l00116"></a>00116                         {
<a name="l00117"></a>00117                                 <span class="comment">//Create a new entry at end and link it to the heap</span>
<a name="l00118"></a>00118                                 <a class="code" href="structheap__entry.html">heap_entry_t</a> * nptr = (<a class="code" href="structheap__entry.html">heap_entry_t</a> *) end;
<a name="l00119"></a>00119                                 nptr-&gt;<a class="code" href="structheap__entry.html#a4c6c3bc56b1a413e4cf5020927df2b57">used</a> = 0;
<a name="l00120"></a>00120                                 nptr-&gt;<a class="code" href="structheap__entry.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a> = <a class="code" href="virt__mm_8h.html#a6223bf065444cd678be8eb78bebaa5ba">PAGE_SIZE</a>;
<a name="l00121"></a>00121                                 nptr-&gt;<a class="code" href="structheap__entry.html#a8bc8f936f7d3b69b921f7339ff6f1cc9">prev</a> = ptr;
<a name="l00122"></a>00122                                 nptr-&gt;<a class="code" href="structheap__entry.html#a90018fa1ca3eed17d857c9a9785a177b">next</a> = 0;
<a name="l00123"></a>00123                                 ptr-&gt;<a class="code" href="structheap__entry.html#a90018fa1ca3eed17d857c9a9785a177b">next</a> = nptr;
<a name="l00124"></a>00124                         }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 
<a name="l00127"></a>00127                         <span class="keywordflow">return</span> <a class="code" href="_kernel_2sources_2heap_2heap_8c.html#a24a780b4e38547b00f955a39a83a466f" title="Allocates x bytes of memory from a heap, expanding it if necessary.">heapAllocateMemory</a>(size, heap);
<a name="l00128"></a>00128                 }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130                 ptr = (<a class="code" href="structheap__entry.html">heap_entry_t</a> *) ptr-&gt;<a class="code" href="structheap__entry.html#a90018fa1ca3eed17d857c9a9785a177b">next</a>; <span class="comment">//Move onto the next chunk</span>
<a name="l00131"></a>00131         }
<a name="l00132"></a>00132 
<a name="l00133"></a>00133         <span class="keywordflow">return</span> 0;
<a name="l00134"></a>00134 }
<a name="l00135"></a>00135 
<a name="l00141"></a><a class="code" href="_kernel_2sources_2heap_2heap_8c.html#a26b7c9cdab062506e23b0adad898871f">00141</a> <span class="keywordtype">void</span> <a class="code" href="_kernel_2sources_2heap_2heap_8c.html#a26b7c9cdab062506e23b0adad898871f" title="Free&amp;#39;s the memory at location address on the heap specified. Shrinking if necessary.">heapFreeMemory</a>(<a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> address, <a class="code" href="structheap__t.html">heap_t</a> * heap)
<a name="l00142"></a>00142 {
<a name="l00143"></a>00143         <a class="code" href="structheap__entry.html">heap_entry_t</a> * ptr = (<a class="code" href="structheap__entry.html">heap_entry_t</a> *) (address - <span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>));
<a name="l00144"></a>00144         <a class="code" href="structheap__entry.html">heap_entry_t</a> * optr = 0;
<a name="l00145"></a>00145 
<a name="l00146"></a>00146         <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structheap__entry.html#a4c6c3bc56b1a413e4cf5020927df2b57">used</a> == 0) <span class="comment">//If this happens then somethings gone wrong. Wtf moment much?</span>
<a name="l00147"></a>00147         {
<a name="l00148"></a>00148                 <span class="keywordflow">return</span>;
<a name="l00149"></a>00149         }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151         ptr-&gt;<a class="code" href="structheap__entry.html#a4c6c3bc56b1a413e4cf5020927df2b57">used</a> = 0;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153         <span class="keywordflow">while</span> (1)
<a name="l00154"></a>00154         {
<a name="l00155"></a>00155                 <span class="comment">//UNIFY Left</span>
<a name="l00156"></a>00156                 optr = ptr-&gt;<a class="code" href="structheap__entry.html#a8bc8f936f7d3b69b921f7339ff6f1cc9">prev</a>;
<a name="l00157"></a>00157                 <span class="keywordflow">if</span> (optr != 0) 
<a name="l00158"></a>00158                 {
<a name="l00159"></a>00159                         <span class="keywordflow">if</span> (optr-&gt;<a class="code" href="structheap__entry.html#a4c6c3bc56b1a413e4cf5020927df2b57">used</a> == 0) <span class="comment">//Can be unified!</span>
<a name="l00160"></a>00160                         { 
<a name="l00161"></a>00161                                 optr-&gt;<a class="code" href="structheap__entry.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a> = optr-&gt;<a class="code" href="structheap__entry.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>) + ptr-&gt;<a class="code" href="structheap__entry.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a>;
<a name="l00162"></a>00162                                 optr-&gt;<a class="code" href="structheap__entry.html#a90018fa1ca3eed17d857c9a9785a177b">next</a> = ptr-&gt;<a class="code" href="structheap__entry.html#a90018fa1ca3eed17d857c9a9785a177b">next</a>;
<a name="l00163"></a>00163                                 ptr = optr;
<a name="l00164"></a>00164                         }
<a name="l00165"></a>00165                         <span class="keywordflow">else</span>
<a name="l00166"></a>00166                         {
<a name="l00167"></a>00167                                 <span class="keywordflow">break</span>;
<a name="l00168"></a>00168                         }
<a name="l00169"></a>00169                 } 
<a name="l00170"></a>00170                 <span class="keywordflow">else</span> 
<a name="l00171"></a>00171                 {
<a name="l00172"></a>00172                         <span class="keywordflow">break</span>;
<a name="l00173"></a>00173                 }
<a name="l00174"></a>00174         }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176         <span class="keywordflow">while</span> (1) 
<a name="l00177"></a>00177         {
<a name="l00178"></a>00178                 <span class="comment">//UNIFY Right</span>
<a name="l00179"></a>00179                 optr = ptr-&gt;<a class="code" href="structheap__entry.html#a90018fa1ca3eed17d857c9a9785a177b">next</a>;
<a name="l00180"></a>00180                 <span class="keywordflow">if</span> (optr != 0) 
<a name="l00181"></a>00181                 {
<a name="l00182"></a>00182                         <span class="keywordflow">if</span> (optr-&gt;<a class="code" href="structheap__entry.html#a4c6c3bc56b1a413e4cf5020927df2b57">used</a> == 0) <span class="comment">//Can be unified!</span>
<a name="l00183"></a>00183                         { 
<a name="l00184"></a>00184                                 ptr-&gt;<a class="code" href="structheap__entry.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a> = ptr-&gt;<a class="code" href="structheap__entry.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>) + optr-&gt;<a class="code" href="structheap__entry.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a>;
<a name="l00185"></a>00185                                 ptr-&gt;<a class="code" href="structheap__entry.html#a90018fa1ca3eed17d857c9a9785a177b">next</a> = optr-&gt;<a class="code" href="structheap__entry.html#a90018fa1ca3eed17d857c9a9785a177b">next</a>;
<a name="l00186"></a>00186                         } 
<a name="l00187"></a>00187                         <span class="keywordflow">else</span> 
<a name="l00188"></a>00188                         { 
<a name="l00189"></a>00189                                 <span class="keywordflow">break</span>; 
<a name="l00190"></a>00190                         }
<a name="l00191"></a>00191                 } 
<a name="l00192"></a>00192                 <span class="keywordflow">else</span> 
<a name="l00193"></a>00193                 { 
<a name="l00194"></a>00194                         <span class="keywordflow">break</span>; 
<a name="l00195"></a>00195                 }
<a name="l00196"></a>00196         }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198         <span class="comment">//Check if this is the last entry</span>
<a name="l00199"></a>00199         <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structheap__entry.html#a90018fa1ca3eed17d857c9a9785a177b">next</a> == 0) 
<a name="l00200"></a>00200         {
<a name="l00201"></a>00201                 
<a name="l00202"></a>00202         }
<a name="l00203"></a>00203 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Thu Oct 7 2010 08:20:14 for Dawn OS by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
