<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Dawn OS: Kernel/sources/heap/heap.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = 'open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = 'closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="dir_088092151735f89563dde47603586e87.html">Kernel</a>      </li>
      <li><a class="el" href="dir_7726e6a0004e7ef457b2bce5429be716.html">sources</a>      </li>
      <li><a class="el" href="dir_68d54059cb2d51b7dacefef6af8efb0e.html">heap</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>heap.c</h1>  </div>
</div>
<div class="contents">
<a href="heap_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &lt;<a class="code" href="heap_8h.html">heap/heap.h</a>&gt;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &lt;<a class="code" href="Kernel_2headers_2printf_8h.html">printf.h</a>&gt;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html">debug/debug.h</a>&gt;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;<a class="code" href="panic_8h.html">panic/panic.h</a>&gt;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;<a class="code" href="virt__mm_8h.html">mm/virt_mm.h</a>&gt;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;<a class="code" href="phys__mm_8h.html">mm/phys_mm.h</a>&gt;</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> <a class="code" href="heap_8c.html#ab80d68399dbb045d1b1b821c560ec7df">alloc_mem</a>(<a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> <a class="code" href="multiboot_8h.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a>, <a class="code" href="structheap__t.html">heap_t</a> * heap);
<a name="l00009"></a>00009 <span class="keywordtype">void</span> <a class="code" href="heap_8c.html#adcb6f95229d37c5dbfd89ce01280b178">free_mem</a>(<a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> address, <a class="code" href="structheap__t.html">heap_t</a> * heap);
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="comment">//Does memory mapping itself, no need to map the first frame of the heap - and if you do you will lose memory to the void.</span>
<a name="l00012"></a><a class="code" href="heap_8c.html#ade657aeee4e0f8c2b0b4593bcff4af81">00012</a> <span class="keywordtype">void</span> <a class="code" href="heap_8c.html#ade657aeee4e0f8c2b0b4593bcff4af81">initializeHeap</a>(<a class="code" href="structheap__t.html">heap_t</a> * heap, <a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> address)
<a name="l00013"></a>00013 {
<a name="l00014"></a>00014         <span class="comment">//Double check the heap ptr is valid</span>
<a name="l00015"></a>00015         <span class="keywordflow">if</span> (heap == 0) <span class="keywordflow">return</span>;
<a name="l00016"></a>00016 
<a name="l00017"></a>00017         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Debug Message: Creating Heap\n&quot;</span>);
<a name="l00018"></a>00018         <a class="code" href="common_8h.html#ab0985f366b55a4fd2d24cefe66340bc0">memset</a>(heap, 0, <span class="keyword">sizeof</span>(<a class="code" href="structheap__t.html">heap_t</a>));
<a name="l00019"></a>00019         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Debug Message: 0&#39;ed Heap\n&quot;</span>);
<a name="l00020"></a>00020 
<a name="l00021"></a>00021         <span class="comment">//Set the heap location to the specified address</span>
<a name="l00022"></a>00022         heap-&gt;<a class="code" href="structheap__t.html#a822b345b413344a5ceb4618904537e82">heap_location</a> = address &amp; PAGE_MASK; <span class="comment">//Page aligned boundry</span>
<a name="l00023"></a>00023         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Debug Message: Heap Location &quot;</span>);
<a name="l00024"></a>00024         <a class="code" href="debugprint_8h.html#ac60b666ea684eb88d4ccd46b08759ca7">DEBUG_PRINTX</a>(heap-&gt;<a class="code" href="structheap__t.html#a822b345b413344a5ceb4618904537e82">heap_location</a>);
<a name="l00025"></a>00025         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00026"></a>00026 
<a name="l00027"></a>00027         <a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> frame_addr = 0;
<a name="l00028"></a>00028 
<a name="l00029"></a>00029         frame_addr = 0;
<a name="l00030"></a>00030 
<a name="l00031"></a>00031         frame_addr = <a class="code" href="phys__mm_8h.html#ae86135800d71ebffbb2785b058373cd4">allocateFrame</a>();
<a name="l00032"></a>00032 
<a name="l00033"></a>00033         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Debug Message: Allocated frame &quot;</span>);
<a name="l00034"></a>00034         <a class="code" href="debugprint_8h.html#ac60b666ea684eb88d4ccd46b08759ca7">DEBUG_PRINTX</a>(frame_addr);
<a name="l00035"></a>00035         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00036"></a>00036 
<a name="l00037"></a>00037         <a class="code" href="virt__mm_8h.html#a8aa47a82f681426ba335dd779424f705">map</a>(heap-&gt;<a class="code" href="structheap__t.html#a822b345b413344a5ceb4618904537e82">heap_location</a>, frame_addr, <a class="code" href="virt__mm_8h.html#a122dfc414a40e260fd35dbe9743db26f">PAGE_PRESENT</a> | <a class="code" href="virt__mm_8h.html#a2d0253527ea5080d6befe0ee3bde473f">PAGE_USER</a>);
<a name="l00038"></a>00038 
<a name="l00039"></a>00039         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Debug Message: Mapped Heap\n&quot;</span>);
<a name="l00040"></a>00040 
<a name="l00041"></a>00041         <a class="code" href="common_8h.html#ab0985f366b55a4fd2d24cefe66340bc0">memset</a>(heap-&gt;<a class="code" href="structheap__t.html#a822b345b413344a5ceb4618904537e82">heap_location</a>, 0, 4096);
<a name="l00042"></a>00042         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Debug Message: 0&#39;ed HEAP\n&quot;</span>);
<a name="l00043"></a>00043 
<a name="l00044"></a>00044         <a class="code" href="structheap__entry.html">heap_entry_t</a> * ptr = (<a class="code" href="structheap__entry.html">heap_entry_t</a> *) heap-&gt;<a class="code" href="structheap__t.html#a822b345b413344a5ceb4618904537e82">heap_location</a>;
<a name="l00045"></a>00045         <a class="code" href="common_8h.html#ab0985f366b55a4fd2d24cefe66340bc0">memset</a>(ptr, 0, <span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>)); <span class="comment">//Initialize it.</span>
<a name="l00046"></a>00046         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Debug Message: Created first heap entry\n&quot;</span>);
<a name="l00047"></a>00047 
<a name="l00048"></a>00048         ptr-&gt;<a class="code" href="structheap__entry.html#ac671a08602b18399f8b21ebacc46fe6a">used</a> = 0; <span class="comment">//Not used</span>
<a name="l00049"></a>00049         ptr-&gt;<a class="code" href="structheap__entry.html#a9133349c98d74429e7e8441d88e08cd6">size</a> = <a class="code" href="virt__mm_8h.html#a6223bf065444cd678be8eb78bebaa5ba">PAGE_SIZE</a> - <span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>); <span class="comment">//One frame has been allocated. 4096 bytes of heap space at the minute. The heap entrys are also in the space so we need to take into account for them (Only one at the minute though =) )</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Debug Message: Set ptr size\n&quot;</span>);
<a name="l00052"></a>00052 
<a name="l00053"></a>00053         ptr-&gt;<a class="code" href="structheap__entry.html#a5eb7bbd3aeb64622bb4bb843d44c9b06">next</a> = 0; <span class="comment">//ptr-&gt;next = NULL, this tells the heap that this is the last entry on the heap.</span>
<a name="l00054"></a>00054         ptr-&gt;<a class="code" href="structheap__entry.html#a9fbde1b1963b161058f5e1319a166672">prev</a> = 0;
<a name="l00055"></a>00055         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Debug Message: Ptr-&gt;next set\n&quot;</span>);
<a name="l00056"></a>00056 }
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="heap_8c.html#a24a780b4e38547b00f955a39a83a466f">00058</a> <a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> <a class="code" href="heap_8c.html#a24a780b4e38547b00f955a39a83a466f">heapAllocateMemory</a>(<a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> <a class="code" href="multiboot_8h.html#a0d40f1591c12f359c3fa3f982f9a221d">size</a>, <a class="code" href="structheap__t.html">heap_t</a>* heap) 
<a name="l00059"></a>00059 {
<a name="l00060"></a>00060         <a class="code" href="structheap__entry.html">heap_entry_t</a>* ptr = (<a class="code" href="structheap__entry.html">heap_entry_t</a>*) heap-&gt;<a class="code" href="structheap__t.html#a822b345b413344a5ceb4618904537e82">heap_location</a>;
<a name="l00061"></a>00061         <a class="code" href="int__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> result = 0;
<a name="l00062"></a>00062 
<a name="l00063"></a>00063         while (1) 
<a name="l00064"></a>00064         {
<a name="l00065"></a>00065 
<a name="l00066"></a>00066                 <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structheap__entry.html#ac671a08602b18399f8b21ebacc46fe6a">used</a> == 0) <span class="comment">//Is the chunk in use?</span>
<a name="l00067"></a>00067                 { 
<a name="l00068"></a>00068                         <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structheap__entry.html#a9133349c98d74429e7e8441d88e08cd6">size</a> &gt; size) <span class="comment">//Is it big enough!?!</span>
<a name="l00069"></a>00069                         { 
<a name="l00070"></a>00070                                 ptr-&gt;<a class="code" href="structheap__entry.html#ac671a08602b18399f8b21ebacc46fe6a">used</a> = 1; <span class="comment">//Yay it fits!</span>
<a name="l00071"></a>00071                                 
<a name="l00072"></a>00072                                 <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structheap__entry.html#a9133349c98d74429e7e8441d88e08cd6">size</a> &lt; size + (<span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>))) 
<a name="l00073"></a>00073                                 { <span class="comment">//If another chunk of memory wont fit then just allocate a few more bytes then asked for (Avoid leak)</span>
<a name="l00074"></a>00074                                         <span class="comment">//Don&#39;t actually need to do anything. The next ptr is still the next pointer</span>
<a name="l00075"></a>00075                                 } 
<a name="l00076"></a>00076                                 <span class="keywordflow">else</span> 
<a name="l00077"></a>00077                                 {
<a name="l00078"></a>00078                                         <a class="code" href="structheap__entry.html">heap_entry_t</a>* newptr = (<a class="code" href="structheap__entry.html">heap_entry_t</a>*) (((<a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a>) ptr) + <span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>) + size);
<a name="l00079"></a>00079                                         newptr-&gt;<a class="code" href="structheap__entry.html#ac671a08602b18399f8b21ebacc46fe6a">used</a> = 0;
<a name="l00080"></a>00080                                         newptr-&gt;<a class="code" href="structheap__entry.html#a9133349c98d74429e7e8441d88e08cd6">size</a> = ptr-&gt;<a class="code" href="structheap__entry.html#a9133349c98d74429e7e8441d88e08cd6">size</a> - size - <span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>);
<a name="l00081"></a>00081                                         newptr-&gt;<a class="code" href="structheap__entry.html#a5eb7bbd3aeb64622bb4bb843d44c9b06">next</a> = ptr-&gt;<a class="code" href="structheap__entry.html#a5eb7bbd3aeb64622bb4bb843d44c9b06">next</a>;
<a name="l00082"></a>00082                                         newptr-&gt;<a class="code" href="structheap__entry.html#a9fbde1b1963b161058f5e1319a166672">prev</a> = ptr;
<a name="l00083"></a>00083                                         ptr-&gt;<a class="code" href="structheap__entry.html#a5eb7bbd3aeb64622bb4bb843d44c9b06">next</a> = newptr;
<a name="l00084"></a>00084                                         ptr-&gt;<a class="code" href="structheap__entry.html#a9133349c98d74429e7e8441d88e08cd6">size</a> = size;
<a name="l00085"></a>00085                                 }
<a name="l00086"></a>00086 
<a name="l00087"></a>00087                                 <span class="keywordflow">return</span> ((<a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a>) ptr) + <span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>); <span class="comment">//Return the location of the actual memory not the header</span>
<a name="l00088"></a>00088                         }
<a name="l00089"></a>00089                 }
<a name="l00090"></a>00090 
<a name="l00091"></a>00091                 <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structheap__entry.html#a5eb7bbd3aeb64622bb4bb843d44c9b06">next</a> == 0) 
<a name="l00092"></a>00092                 {
<a name="l00093"></a>00093                         <a class="code" href="debugprint_8h.html#af6551f0b4c3964c3128f808e7bf987c7">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Heap expanded by 4KB\n&quot;</span>);
<a name="l00094"></a>00094                         <span class="comment">//Map another 4kb onto the heap</span>
<a name="l00095"></a>00095                         <span class="comment">//This is the last entry on the heap SO if its not used we can just += the size otherwise we have to create a whole new one (More work for mee)</span>
<a name="l00096"></a>00096 
<a name="l00097"></a>00097                         <a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> frame_addr = <a class="code" href="phys__mm_8h.html#ae86135800d71ebffbb2785b058373cd4">allocateFrame</a>();
<a name="l00098"></a>00098                         <a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> end = ((uint32) ptr) + ptr-&gt;<a class="code" href="structheap__entry.html#a9133349c98d74429e7e8441d88e08cd6">size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>);
<a name="l00099"></a>00099 
<a name="l00100"></a>00100                         <a class="code" href="virt__mm_8h.html#a8aa47a82f681426ba335dd779424f705">map</a>(end, frame_addr, <a class="code" href="virt__mm_8h.html#a122dfc414a40e260fd35dbe9743db26f">PAGE_PRESENT</a> | <a class="code" href="virt__mm_8h.html#a2d0253527ea5080d6befe0ee3bde473f">PAGE_USER</a>); <span class="comment">//Mapped now! =)</span>
<a name="l00101"></a>00101 
<a name="l00102"></a>00102                         <a class="code" href="common_8h.html#ab0985f366b55a4fd2d24cefe66340bc0">memset</a>(end, 0, 4096);
<a name="l00103"></a>00103                         
<a name="l00104"></a>00104                         <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structheap__entry.html#ac671a08602b18399f8b21ebacc46fe6a">used</a> == 0) 
<a name="l00105"></a>00105                         {
<a name="l00106"></a>00106                                 ptr-&gt;<a class="code" href="structheap__entry.html#a9133349c98d74429e7e8441d88e08cd6">size</a> += 4096;
<a name="l00107"></a>00107                         } 
<a name="l00108"></a>00108                         <span class="keywordflow">else</span> 
<a name="l00109"></a>00109                         {
<a name="l00110"></a>00110                                 <span class="comment">//Create a new entry at end and link it to the heap</span>
<a name="l00111"></a>00111                                 <a class="code" href="structheap__entry.html">heap_entry_t</a> * nptr = (<a class="code" href="structheap__entry.html">heap_entry_t</a> *) end;
<a name="l00112"></a>00112                                 nptr-&gt;<a class="code" href="structheap__entry.html#ac671a08602b18399f8b21ebacc46fe6a">used</a> = 0;
<a name="l00113"></a>00113                                 nptr-&gt;<a class="code" href="structheap__entry.html#a9133349c98d74429e7e8441d88e08cd6">size</a> = <a class="code" href="virt__mm_8h.html#a6223bf065444cd678be8eb78bebaa5ba">PAGE_SIZE</a>;
<a name="l00114"></a>00114                                 nptr-&gt;<a class="code" href="structheap__entry.html#a9fbde1b1963b161058f5e1319a166672">prev</a> = ptr;
<a name="l00115"></a>00115                                 nptr-&gt;<a class="code" href="structheap__entry.html#a5eb7bbd3aeb64622bb4bb843d44c9b06">next</a> = 0;
<a name="l00116"></a>00116                                 ptr-&gt;<a class="code" href="structheap__entry.html#a5eb7bbd3aeb64622bb4bb843d44c9b06">next</a> = nptr;
<a name="l00117"></a>00117                         }
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 
<a name="l00120"></a>00120                         <span class="keywordflow">return</span> <a class="code" href="heap_8c.html#a24a780b4e38547b00f955a39a83a466f">heapAllocateMemory</a>(size, heap);
<a name="l00121"></a>00121                 }
<a name="l00122"></a>00122 
<a name="l00123"></a>00123                 ptr = (<a class="code" href="structheap__entry.html">heap_entry_t</a> *) ptr-&gt;<a class="code" href="structheap__entry.html#a5eb7bbd3aeb64622bb4bb843d44c9b06">next</a>; <span class="comment">//Move onto the next chunk</span>
<a name="l00124"></a>00124         }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126         <span class="keywordflow">return</span> 0;
<a name="l00127"></a>00127 }
<a name="l00128"></a>00128 
<a name="l00129"></a><a class="code" href="heap_8c.html#a26b7c9cdab062506e23b0adad898871f">00129</a> <span class="keywordtype">void</span> <a class="code" href="heap_8c.html#a26b7c9cdab062506e23b0adad898871f">heapFreeMemory</a>(<a class="code" href="int__types_8h.html#a1134b580f8da4de94ca6b1de4d37975e">uint32</a> address, <a class="code" href="structheap__t.html">heap_t</a> * heap)
<a name="l00130"></a>00130 {
<a name="l00131"></a>00131         <a class="code" href="structheap__entry.html">heap_entry_t</a> * ptr = (<a class="code" href="structheap__entry.html">heap_entry_t</a> *) (address - <span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>));
<a name="l00132"></a>00132         <a class="code" href="structheap__entry.html">heap_entry_t</a> * optr = 0;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134         <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structheap__entry.html#ac671a08602b18399f8b21ebacc46fe6a">used</a> == 0) <span class="comment">//If this happens then somethings gone wrong. Wtf moment much?</span>
<a name="l00135"></a>00135         {
<a name="l00136"></a>00136                 <span class="keywordflow">return</span>;
<a name="l00137"></a>00137         }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139         ptr-&gt;<a class="code" href="structheap__entry.html#ac671a08602b18399f8b21ebacc46fe6a">used</a> = 0;
<a name="l00140"></a>00140 
<a name="l00141"></a>00141         <span class="keywordflow">while</span> (1)
<a name="l00142"></a>00142         {
<a name="l00143"></a>00143                 <span class="comment">//UNIFY Left</span>
<a name="l00144"></a>00144                 optr = ptr-&gt;<a class="code" href="structheap__entry.html#a9fbde1b1963b161058f5e1319a166672">prev</a>;
<a name="l00145"></a>00145                 <span class="keywordflow">if</span> (optr != 0) 
<a name="l00146"></a>00146                 {
<a name="l00147"></a>00147                         <span class="keywordflow">if</span> (optr-&gt;<a class="code" href="structheap__entry.html#ac671a08602b18399f8b21ebacc46fe6a">used</a> == 0) <span class="comment">//Can be unified!</span>
<a name="l00148"></a>00148                         { 
<a name="l00149"></a>00149                                 optr-&gt;<a class="code" href="structheap__entry.html#a9133349c98d74429e7e8441d88e08cd6">size</a> = optr-&gt;<a class="code" href="structheap__entry.html#a9133349c98d74429e7e8441d88e08cd6">size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>) + ptr-&gt;<a class="code" href="structheap__entry.html#a9133349c98d74429e7e8441d88e08cd6">size</a>;
<a name="l00150"></a>00150                                 optr-&gt;<a class="code" href="structheap__entry.html#a5eb7bbd3aeb64622bb4bb843d44c9b06">next</a> = ptr-&gt;<a class="code" href="structheap__entry.html#a5eb7bbd3aeb64622bb4bb843d44c9b06">next</a>;
<a name="l00151"></a>00151                                 ptr = optr;
<a name="l00152"></a>00152                         }
<a name="l00153"></a>00153                         <span class="keywordflow">else</span>
<a name="l00154"></a>00154                         {
<a name="l00155"></a>00155                                 <span class="keywordflow">break</span>;
<a name="l00156"></a>00156                         }
<a name="l00157"></a>00157                 } 
<a name="l00158"></a>00158                 <span class="keywordflow">else</span> 
<a name="l00159"></a>00159                 {
<a name="l00160"></a>00160                         <span class="keywordflow">break</span>;
<a name="l00161"></a>00161                 }
<a name="l00162"></a>00162         }
<a name="l00163"></a>00163 
<a name="l00164"></a>00164         <span class="keywordflow">while</span> (1) 
<a name="l00165"></a>00165         {
<a name="l00166"></a>00166                 <span class="comment">//UNIFY Right</span>
<a name="l00167"></a>00167                 optr = ptr-&gt;<a class="code" href="structheap__entry.html#a5eb7bbd3aeb64622bb4bb843d44c9b06">next</a>;
<a name="l00168"></a>00168                 <span class="keywordflow">if</span> (optr != 0) 
<a name="l00169"></a>00169                 {
<a name="l00170"></a>00170                         <span class="keywordflow">if</span> (optr-&gt;<a class="code" href="structheap__entry.html#ac671a08602b18399f8b21ebacc46fe6a">used</a> == 0) <span class="comment">//Can be unified!</span>
<a name="l00171"></a>00171                         { 
<a name="l00172"></a>00172                                 ptr-&gt;<a class="code" href="structheap__entry.html#a9133349c98d74429e7e8441d88e08cd6">size</a> = ptr-&gt;<a class="code" href="structheap__entry.html#a9133349c98d74429e7e8441d88e08cd6">size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structheap__entry.html">heap_entry_t</a>) + optr-&gt;<a class="code" href="structheap__entry.html#a9133349c98d74429e7e8441d88e08cd6">size</a>;
<a name="l00173"></a>00173                                 ptr-&gt;<a class="code" href="structheap__entry.html#a5eb7bbd3aeb64622bb4bb843d44c9b06">next</a> = optr-&gt;<a class="code" href="structheap__entry.html#a5eb7bbd3aeb64622bb4bb843d44c9b06">next</a>;
<a name="l00174"></a>00174                         } 
<a name="l00175"></a>00175                         <span class="keywordflow">else</span> 
<a name="l00176"></a>00176                         { 
<a name="l00177"></a>00177                                 <span class="keywordflow">break</span>; 
<a name="l00178"></a>00178                         }
<a name="l00179"></a>00179                 } 
<a name="l00180"></a>00180                 <span class="keywordflow">else</span> 
<a name="l00181"></a>00181                 { 
<a name="l00182"></a>00182                         <span class="keywordflow">break</span>; 
<a name="l00183"></a>00183                 }
<a name="l00184"></a>00184         }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186         <span class="comment">//Check if this is the last entry</span>
<a name="l00187"></a>00187         <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structheap__entry.html#a5eb7bbd3aeb64622bb4bb843d44c9b06">next</a> == 0) 
<a name="l00188"></a>00188         {
<a name="l00189"></a>00189                 <span class="comment">//TODO: Shrinking the heap!</span>
<a name="l00190"></a>00190         }
<a name="l00191"></a>00191 }
</pre></div></div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Tue Oct 5 2010 22:08:48 for Dawn OS by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
